<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Town Builder</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
        #canvas-container { width: 100%; height: 100%; display: block; }
        #canvas-container canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        #town-name-display {
            position: absolute;
            top: 66px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            text-align: center;
            min-width: 200px;
            cursor: pointer;
        }

        #town-name-input {
            text-align: center;
            width: 200px;
            display: none;
        }

        #toolbar {
            position: absolute;
            top: 66px;
            left: 10px;
            max-height: calc(100vh - 76px);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            width: 280px;
        }

        #toolbar .card-body {
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 96px);
            overflow: hidden;
        }

        .mode-buttons {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 10px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        #model-container {
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1 1 auto;
            min-height: 0;
            padding-right: 5px;
        }

        /* Custom scrollbar for model container */
        #model-container::-webkit-scrollbar {
            width: 8px;
        }

        #model-container::-webkit-scrollbar-track {
            background: var(--bs-light);
            border-radius: 4px;
        }

        #model-container::-webkit-scrollbar-thumb {
            background: var(--bs-secondary);
            border-radius: 4px;
        }

        #model-container::-webkit-scrollbar-thumb:hover {
            background: var(--bs-secondary-dark);
        }

        [data-bs-theme="dark"] #model-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        [data-bs-theme="dark"] #model-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
        }

        [data-bs-theme="dark"] #model-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .toolbar-bottom-section {
            flex-shrink: 0;
            margin-top: auto;
        }

        .model-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .model-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Theme toggle button */
        .theme-toggle {
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .theme-toggle:hover {
            transform: rotate(20deg);
        }

    </style>
</head>
<body>
    <!-- Bootstrap Navigation Bar -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                <i class="bi bi-building me-2"></i>Simple Town Builder
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="bi bi-house-door me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="bi bi-info-circle me-1"></i>About
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <button class="btn btn-link nav-link theme-toggle" id="themeToggle" title="Toggle theme">
                            <i class="bi bi-sun-fill" id="themeIcon"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Town Name Display -->
    <div id="town-name-container" style="position: absolute; top: 66px; left: 50%; transform: translateX(-50%); z-index: 1000;">
        <div id="town-name-display" class="badge bg-dark bg-opacity-75 fs-5 px-3 py-2">My Town</div>
        <input id="town-name-input" type="text" value="My Town" class="form-control form-control-sm">
    </div>

    <!-- User List -->
    <div id="user-list" class="position-absolute top-0 end-0 m-3 mt-5 card shadow-sm" style="z-index: 1000; min-width: 150px; margin-top: 66px !important;">
        <div class="card-body">
            <h6 class="card-title mb-2"><i class="bi bi-people-fill me-2"></i>Users</h6>
            <ul id="user-list-ul" class="list-unstyled mb-0"></ul>
        </div>
    </div>

    <!-- Toolbar -->
    <div id="toolbar" class="card shadow">
        <div class="card-body">
            <h5 class="card-title mb-3"><i class="bi bi-tools me-2"></i>Town Builder</h5>
            <div class="mode-buttons">
                <button class="btn btn-sm btn-success active mode-button" data-mode="place">
                    <i class="bi bi-plus-circle me-1"></i>Place
                </button>
                <button class="btn btn-sm btn-primary mode-button" data-mode="edit">
                    <i class="bi bi-pencil me-1"></i>Edit
                </button>
                <button class="btn btn-sm btn-danger mode-button" data-mode="delete">
                    <i class="bi bi-trash me-1"></i>Delete
                </button>
                <button class="btn btn-sm btn-info mode-button" data-mode="drive">
                    <i class="bi bi-car-front me-1"></i>Drive
                </button>
            </div>
            <div id="model-container" class="mt-3">
                {% for category, model_list in models.items() %}
                <div class="category mb-3">
                    <h6 class="text-uppercase text-muted mb-2">{{ category|title }}</h6>
                    <div class="list-group list-group-flush">
                        {% for model in model_list %}
                        <a href="#" class="list-group-item list-group-item-action model-item py-2" data-category="{{ category }}" data-model="{{ model }}">
                            <i class="bi bi-box me-2"></i>{{ model.split('.')[0]|title }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Bottom section with buttons and controls (doesn't scroll) -->
            <div class="toolbar-bottom-section">
                <div class="d-grid gap-2 mt-3">
                    <button id="clear-scene" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-trash me-1"></i>Clear Scene
                    </button>
                    <div class="btn-group" role="group">
                        <button id="save-scene" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-save me-1"></i>Save
                        </button>
                        <button id="load-scene" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-folder-open me-1"></i>Load
                        </button>
                    </div>
                </div>

                <!-- Scene Color Controls -->
                <div class="mt-3 pt-3 border-top">
                    <h6 class="mb-3"><i class="bi bi-palette me-2"></i>Scene Colors</h6>
                    <div class="mb-2">
                        <label for="skyColorPicker" class="form-label small mb-1">Sky Color</label>
                        <input type="color" id="skyColorPicker" value="#87CEEB" class="form-control form-control-color w-100">
                    </div>
                    <div>
                        <label for="groundColorPicker" class="form-label small mb-1">Ground Color</label>
                        <input type="color" id="groundColorPicker" value="#2E8B57" class="form-control form-control-color w-100">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="canvas-container"></div>

    <!-- Joystick for mobile driving mode -->
    <div id="joystick-container" class="position-absolute" style="display:none; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 2002;">
        <div id="joystick-base" class="bg-dark bg-opacity-25 rounded-circle position-relative" style="width: 120px; height: 120px;">
            <div id="joystick-stick" class="bg-success bg-opacity-50 rounded-circle position-absolute" style="width: 60px; height: 60px; left: 30px; top: 30px; touch-action: none;"></div>
        </div>
    </div>

    <!-- Exit Driving Mode Button -->
    <button id="exit-driving-btn" class="btn btn-danger position-absolute" style="display:none; top: 70px; right: 20px; z-index: 2002;">
        <i class="bi bi-x-circle me-1"></i>Exit Driving Mode
    </button>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Theme Toggle Script -->
    <script>
        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const html = document.documentElement;

        // Check for saved theme preference or default to 'light'
        const currentTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-bs-theme', currentTheme);
        updateThemeIcon(currentTheme);

        themeToggle.addEventListener('click', () => {
            const newTheme = html.getAttribute('data-bs-theme') === 'light' ? 'dark' : 'light';
            html.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        });

        function updateThemeIcon(theme) {
            if (theme === 'dark') {
                themeIcon.classList.remove('bi-sun-fill');
                themeIcon.classList.add('bi-moon-fill');
            } else {
                themeIcon.classList.remove('bi-moon-fill');
                themeIcon.classList.add('bi-sun-fill');
            }
        }
    </script>

    <!-- Embed town_id from server -->
    <script>
      // Set initial town_id if provided from URL parameter
      {% if town_id %}
      window.currentTownId = {{ town_id }};
      console.log("Town ID from URL:", window.currentTownId);
      {% else %}
      window.currentTownId = null;
      {% endif %}
    </script>

    <!-- Import map for Three.js modules -->
    <script type="importmap">
    {
      "imports": {
        "three": "/static/js/three.module.js"
      }
    }
    </script>

    <!-- Load Go WASM runtime -->
    <script src="/static/js/wasm_exec.js"></script>
    <script>
      // Load physics WASM module (Go 1.24+ with Swiss Tables enabled)
      const go = new Go();
      WebAssembly.instantiateStreaming(fetch("/static/wasm/physics.wasm"), go.importObject).then(result => {
        go.run(result.instance);
        console.log("âœ“ Physics WASM loaded (Go 1.24+ with Swiss Tables)");
        console.log("  Performance: 30-60% faster map operations");
      }).catch(err => {
        console.error("Failed to load physics WASM:", err);
      });
    </script>

    <!-- Load main application after WASM -->
    <script type="module" src="/static/js/main.js"></script>
</body>
</html>
